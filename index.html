<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; text-align: center; }
    canvas { width: 100%; max-width: 800px; margin-bottom: 2rem; }
    button { padding: 1rem; font-size: 16px; }
  </style>
</head>
<body>
  <h1>ESP32 Sensor Dashboard (Bluetooth Classic)</h1>
  <button id="connectBtn">Connect to ESP32</button>

  <canvas id="sensorChart"></canvas>

  <script>
    let port, reader;

    const ctx = document.getElementById('sensorChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: 'Temp (Â°C)', borderColor: 'red', data: [], fill: false },
          { label: 'Humidity (%)', borderColor: 'blue', data: [], fill: false },
          { label: 'MQ2', borderColor: 'green', data: [], fill: false },
          { label: 'MQ4', borderColor: 'purple', data: [], fill: false },
          { label: 'MQ5', borderColor: 'orange', data: [], fill: false },
          { label: 'MQ7', borderColor: 'brown', data: [], fill: false },
          { label: 'MQ8', borderColor: 'gray', data: [], fill: false },
          { label: 'MQ9', borderColor: 'black', data: [], fill: false }
        ]
      },
      options: {
        animation: false,
        scales: {
          x: { title: { display: true, text: 'Time' }},
          y: { beginAtZero: true, title: { display: true, text: 'Sensor Value' } }
        }
      }
    });

    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        const inputStream = decoder.readable;
        reader = inputStream.getReader();
        readLoop();
      } catch (err) {
        alert("Connection failed: " + err);
      }
    });

    async function readLoop() {
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) {
          try {
            const data = JSON.parse(value.trim());
            const now = new Date().toLocaleTimeString();

            // Maintain 20 samples
            if (chart.data.labels.length > 20) {
              chart.data.labels.shift();
              chart.data.datasets.forEach(ds => ds.data.shift());
            }

            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(data.temp);
            chart.data.datasets[1].data.push(data.humidity);
            chart.data.datasets[2].data.push(data.mq2);
            chart.data.datasets[3].data.push(data.mq4);
            chart.data.datasets[4].data.push(data.mq5);
            chart.data.datasets[5].data.push(data.mq7);
            chart.data.datasets[6].data.push(data.mq8);
            chart.data.datasets[7].data.push(data.mq9);
            chart.update();
          } catch (err) {
            console.warn("Invalid JSON:", value);
          }
        }
      }
    }
  </script>
</body>
</html>
