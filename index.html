<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Air Quality Monitor</title>
</head>
<body>
  <h1>ESP32 BLE Air Quality Monitor</h1>
  <button onclick="connectBLE()">Connect to ESP32</button>
  <pre id="log"></pre>

  <script>
    const serviceUUID = '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d5e';
    const characteristicUUIDs = {
      temperature: '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d51',
      humidity: '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d52',
      mq2:        '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d53',
      mq5:        '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d54',
      mq4:        '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d55',
      mq7:        '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d56',
      mq8:        '3a58cdc2-fb11-4d5c-8be8-95e0ec7c0d57'
      // mq9 is intentionally omitted
    };

    const log = (msg) => {
      console.log(msg);
      document.getElementById('log').textContent += msg + '\n';
    };

    async function connectBLE() {
      try {
        log("Requesting BLE device...");
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ name: "ESP32-AirQuality" }],
          optionalServices: [serviceUUID]
        });

        const server = await device.gatt.connect();
        log("Connected to device");

        const service = await server.getPrimaryService(serviceUUID);
        log("Service found");

        // Iterate over all characteristics
        for (const [name, uuid] of Object.entries(characteristicUUIDs)) {
          const charac = await service.getCharacteristic(uuid);
          await charac.startNotifications();

          charac.addEventListener("characteristicvaluechanged", (event) => {
            const value = event.target.value.getFloat32(0, true); // little-endian float
            log(`${name.toUpperCase()}: ${value.toFixed(2)}`);
          });

          log(`${name} characteristic set up`);
        }

        log("Notifications started for all available sensors (except mq9)");

      } catch (error) {
        log("Failed to connect: " + error);
      }
    }
  </script>
</body>
</html>
